<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–æ—Å—Ç–∞–≤ –ê–¥–º–∏–Ω–æ–≤</title>
  <style>
.links {
  display: flex;
  gap: 6px;
  margin: 10px 0;
  justify-content: flex-start;
  flex-wrap: wrap;
}

.link-btn {
  background: transparent;
  border: 1px solid var(--accent);
  color: var(--text);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  text-decoration: none;
  outline: none;
  transition: all 0.2s ease;
  white-space: nowrap;
  width: fit-content;
}

.link-btn:hover {
  background: rgba(76, 201, 240, 0.15);
  color: var(--accent);
}
    :root {
      --bg: #0f0f1b;
      --card-bg: #1a1a2e;
      --text: #e6e6ff;
      --accent: #4cc9f0;
      --danger: #f72585;
      --warning-bg: rgba(247, 37, 133, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }
    .header { display: flex; justify-content: flex-end; padding: 12px 0; }
    .avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--accent); display: flex; align-items: center;
      justify-content: center; cursor: pointer;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .add-btn {
      position: fixed; bottom: 24px; right: 24px;
      width: 56px; height: 56px; border-radius: 50%;
      background: var(--accent); color: #0f0f1b;
      font-size: 26px; display: flex; align-items: center;
      justify-content: center; cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      opacity: 0; visibility: hidden; transform: scale(0);
      transition: all 0.3s ease; z-index: 10;
    }
    .add-btn.visible {
      opacity: 1; visibility: visible; transform: scale(1);
    }
    .search-box {
      text-align: center;
      margin: 16px 0;
    }
    .search-box input,
    .filter-box input {
      padding: 10px;
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      background: #2d2d44;
      color: var(--text);
      border: 1px solid #444;
      outline: none;
    }
    .filter-box {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filter-box label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: var(--text);
    }
    .hierarchy {
      display: flex; flex-direction: column; gap: 16px;
      max-width: 800px; margin: 0 auto;
    }
    .role-section {
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 12px;
      color: var(--accent);
      padding-bottom: 6px;
      border-bottom: 1px solid var(--accent);
    }
    .role-card {
      background: var(--card-bg); border-radius: 12px;
      padding: 18px; position: relative;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.4s forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; transform: translateY(0); }
    }
    .role-card.warning { background: var(--warning-bg); }
    .role-title { font-size: 17px; font-weight: bold; margin-bottom: 6px; color: var(--accent); }
    .nickname { font-size: 19px; margin-bottom: 10px; }
    .warnings-line { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    .edit-btn {
      position: absolute; top: 10px; right: 10px;
      background: rgba(255,255,255,0.1); border: none;
      color: var(--accent); width: 28px; height: 28px;
      border-radius: 50%; cursor: pointer;
      opacity: 0; visibility: hidden;
    }
    .role-card:hover .edit-btn {
      opacity: 1; visibility: visible;
    }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex;
      align-items: center; justify-content: center;
      z-index: 100; opacity: 0; visibility: hidden;
      transition: all 0.3s;
    }
    .modal.active {
      opacity: 1; visibility: visible;
    }
    .modal-content {
      background: var(--card-bg); padding: 22px;
      border-radius: 15px; width: 92%; max-width: 500px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h2 {
      margin-bottom: 18px; color: var(--accent); text-align: center;
    }
    .form-group { margin-bottom: 14px; }
    label { display: block; margin-bottom: 5px; font-size: 14px; }
    select, input {
      width: 100%; padding: 10px; border-radius: 8px;
      background: #2d2d44; color: var(--text);
      border: 1px solid #444;
    }
    button {
      background: var(--accent); color: #0f0f1b;
      border: none; padding: 10px 20px;
      border-radius: 8px; cursor: pointer;
      font-weight: bold; width: 100%; margin-top: 14px;
    }
    #deleteBtn {
      background: var(--danger);
      margin-top: 10px;
      display: none;
    }
    .close-modal {
      position: absolute; top: 12px; right: 12px;
      background: none; border: none; color: var(--text);
      font-size: 22px; cursor: pointer;
    }
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .offline-banner {
      background: var(--danger);
      color: white;
      text-align: center;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 6px;
      font-size: 14px;
    }
    @media (max-width: 600px) {
      body { padding: 12px; }
      .add-btn { bottom: 16px; right: 16px; width: 50px; height: 50px; font-size: 24px; }
      .role-card { padding: 14px; }
      .modal-content { padding: 16px; width: 95%; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="avatar" id="authBtn">
    <img src="https://your-image-url-here.com/avatar.png" alt="–ê–≤–∞—Ç–∞—Ä" onerror="this.style.display='none'; this.parentElement.innerHTML='üë§'">
  </div>
</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É...">
</div>

<div class="filter-box">
  <label><input type="checkbox" id="warningsFilter"> –¢–æ–ª—å–∫–æ —Å –≤—ã–≥–æ–≤–æ—Ä–∞–º–∏</label>
</div>

<div id="offlineBanner" class="offline-banner" style="display:none;">
  ‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –ü–æ–∫–∞–∑–∞–Ω—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
</div>

<div class="hierarchy" id="hierarchyContainer">
  <div style="text-align:center; padding:20px;"><div class="spinner"></div></div>
</div>

<div class="add-btn" id="addBtn">+</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <button class="close-modal" id="closeModal">&times;</button>
    <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å</h2>
    <form id="roleForm">
      <div class="form-group">
        <label>–†–æ–ª—å</label>
        <select id="roleSelect" required>
          <option value="–í–ª–∞–¥–µ–ª–µ—Ü">–í–ª–∞–¥–µ–ª–µ—Ü</option>
          <option value="–°–æ–≤–ª–∞–¥–µ–ª–µ—Ü">–°–æ–≤–ª–∞–¥–µ–ª–µ—Ü</option>
          <option value="–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ">–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ</option>
          <option value="–ì–ª. –ê–¥–º–∏–Ω">–ì–ª. –ê–¥–º–∏–Ω</option>
          <option value="–ü–æ–∫—É–ø–Ω–æ–π –ê–¥–º–∏–Ω">–ü–æ–∫—É–ø–Ω–æ–π –ê–¥–º–∏–Ω</option>
          <option value="–ê–¥–º–∏–Ω 2–ª–≤–ª">–ê–¥–º–∏–Ω 2–ª–≤–ª</option>
          <option value="–ê–¥–º–∏–Ω 1–ª–≤–ª">–ê–¥–º–∏–Ω 1–ª–≤–ª</option>
          <option value="–°—Ç–∞–∂–µ—Ä">–°—Ç–∞–∂–µ—Ä</option>
        </select>
      </div>
      <div class="form-group">
        <label>–ù–∏–∫–Ω–µ–π–º</label>
        <input type="text" id="nickname" required>
      </div>
      <div class="form-group">
        <label>–°–∞–π—Ç</label>
        <input type="url" id="link1" placeholder="https://example.com">
      </div>
      <div class="form-group">
        <label>–°—Ç–∏–º</label>
        <input type="url" id="link2" placeholder="https://steamcommunity.com/id/...">
      </div>
      <div class="form-group">
        <label>–¢–ì</label>
        <input type="url" id="link3" placeholder="https://t.me/...">
      </div>
      <div class="form-group" style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:12px;">
          <div style="flex:1;">
            <label>–¢–µ–∫—É—â–∏–µ –≤—ã–≥–æ–≤–æ—Ä—ã</label>
            <input type="number" id="warnings" min="0" value="0">
          </div>
          <div style="flex:1;">
            <label>–ú–∞–∫—Å. –≤—ã–≥–æ–≤–æ—Ä–æ–≤</label>
            <input type="number" id="maxWarnings" min="1" value="3">
          </div>
        </div>
        <button type="button" id="toggleWarningsBtn" class="link-btn" style="align-self:flex-start; padding:6px 12px; width:auto;">
          –û—Ç–∫–ª—é—á–∏—Ç—å –≤—ã–≥–æ–≤–æ—Ä—ã
        </button>
      </div>
      <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" id="deleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
    </form>
  </div>
</div>

<div class="modal" id="loginModal">
  <div class="modal-content">
    <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <form id="loginForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" required>
      </div>
      <div class="form-group">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="loginPassword" required>
      </div>
      <button type="submit">–í–æ–π—Ç–∏</button>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCdVnWilNkGMkf7BQZmGLuVpEqUTPLjIj0",
    authDomain: "adminsostav.firebaseapp.com",
    projectId: "adminsostav",
    storageBucket: "adminsostav.firebasestorage.app",
    messagingSenderId: "403848315485",
    appId: "1:403848315485:web:16a857b3972ee8b6b503b4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const ROLE_PRIORITY = {
    "–í–ª–∞–¥–µ–ª–µ—Ü": 1,
    "–°–æ–≤–ª–∞–¥–µ–ª–µ—Ü": 2,
    "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ": 3,
    "–ì–ª. –ê–¥–º–∏–Ω": 4,
    "–ü–æ–∫—É–ø–Ω–æ–π –ê–¥–º–∏–Ω": 5,
    "–ê–¥–º–∏–Ω 2–ª–≤–ª": 6,
    "–ê–¥–º–∏–Ω 1–ª–≤–ª": 7,
    "–°—Ç–∞–∂–µ—Ä": 8
  };

  const hierarchyContainer = document.getElementById('hierarchyContainer');
  const addBtn = document.getElementById('addBtn');
  const authBtn = document.getElementById('authBtn');
  const modal = document.getElementById('modal');
  const loginModal = document.getElementById('loginModal');
  const closeModal = document.getElementById('closeModal');
  const roleForm = document.getElementById('roleForm');
  const loginForm = document.getElementById('loginForm');
  const modalTitle = document.getElementById('modalTitle');
  const searchInput = document.getElementById('searchInput');
  const deleteBtn = document.getElementById('deleteBtn');
  const warningsFilter = document.getElementById('warningsFilter');
  const offlineBanner = document.getElementById('offlineBanner');
  const toggleWarningsBtn = document.getElementById('toggleWarningsBtn');

  let currentUser = null;
  let editingDocId = null;
  let allRoles = [];

  const CACHE_KEY = 'roles_cache';
  const CACHE_EXPIRY = 5 * 60 * 1000;

  function showOfflineBanner(show = true) {
    offlineBanner.style.display = show ? 'block' : 'none';
  }

  function isOnline() {
    return navigator.onLine;
  }

  function getCachedData() {
    const cached = localStorage.getItem(CACHE_KEY);
    if (!cached) return null;
    const { data, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp > CACHE_EXPIRY) {
      localStorage.removeItem(CACHE_KEY);
      return null;
    }
    return data;
  }

  function setCachedData(data) {
    localStorage.setItem(CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() }));
  }

  function validateURL(value, type) {
    if (!value) return true;
    try {
      const url = new URL(value);
      if (type === 'steam') {
        return url.hostname === 'steamcommunity.com' && url.pathname.startsWith('/id/');
      } else if (type === 'tg') {
        return url.hostname === 't.me' || (url.hostname === 'telegram.me');
      } else {
        return url.protocol === 'https:';
      }
    } catch {
      return false;
    }
  }

  async function loadAndRenderRoles(useCache = true) {
    let data = null;
    let fromCache = false;

    if (isOnline()) {
      try {
        const q = query(collection(db, "roles"), orderBy("createdAt", "asc"));
        const querySnapshot = await getDocs(q);
        data = [];
        querySnapshot.forEach((doc) => {
          data.push({ id: doc.id, ...doc.data() });
        });
        setCachedData(data);
        showOfflineBanner(false);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:", err);
        if (useCache) {
          data = getCachedData();
          fromCache = !!data;
          if (fromCache) {
            showOfflineBanner(true);
          } else {
            hierarchyContainer.innerHTML = '<p style="color: red; text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            return;
          }
        }
      }
    } else {
      data = getCachedData();
      fromCache = !!data;
      if (fromCache) {
        showOfflineBanner(true);
      } else {
        hierarchyContainer.innerHTML = '<p style="color: #f72585; text-align: center;">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –Ω–µ—Ç –∫—ç—à–∞</p>';
        return;
      }
    }

    if (data) {
      allRoles = data;
      renderRoles();
    }
  }

  function sortRoles(roles) {
    return roles.sort((a, b) => {
      const prioA = ROLE_PRIORITY[a.role] ?? 99;
      const prioB = ROLE_PRIORITY[b.role] ?? 99;
      if (prioA !== prioB) return prioA - prioB;
      return a.nickname.localeCompare(b.nickname, 'ru');
    });
  }

  function groupRolesByRole(roles) {
    const groups = {};
    for (const role of roles) {
      if (!groups[role.role]) groups[role.role] = [];
      groups[role.role].push(role);
    }
    return groups;
  }

  function renderRoles() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const showOnlyWarnings = warningsFilter.checked;

    const filteredRoles = allRoles.filter(role => {
      const matchesSearch = role.nickname.toLowerCase().includes(searchTerm);
      const matchesWarnings = !showOnlyWarnings || (role.warnings > 0 && !(role.warningsDisabled === true));
      return matchesSearch && matchesWarnings;
    });

    const sortedRoles = sortRoles([...filteredRoles]);
    const groups = groupRolesByRole(sortedRoles);

    hierarchyContainer.innerHTML = '';

    if (Object.keys(groups).length === 0) {
      hierarchyContainer.innerHTML = '<p style="text-align:center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
      return;
    }

    const orderedGroups = Object.keys(groups).sort((a, b) => {
      return (ROLE_PRIORITY[a] ?? 99) - (ROLE_PRIORITY[b] ?? 99);
    });

    orderedGroups.forEach(roleName => {
      const section = document.createElement('div');
      section.className = 'role-section';
      section.innerHTML = `<div class="section-title">${roleName}</div>`;
      const container = document.createElement('div');
      groups[roleName].forEach(role => {
        const card = createRoleCard(role, role.id);
        container.appendChild(card);
      });
      section.appendChild(container);
      hierarchyContainer.appendChild(section);
    });
  }

  async function incrementWarnings(docId, delta) {
    const role = allRoles.find(r => r.id === docId);
    if (!role || role.warningsDisabled) return;

    const maxWarn = role.maxWarnings || 3;
    const newWarnings = Math.max(0, Math.min(maxWarn, (role.warnings || 0) + delta));
    try {
      await updateDoc(doc(db, "roles", docId), { warnings: newWarnings });
      role.warnings = newWarnings;
      renderRoles();
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–≥–æ–≤–æ—Ä–æ–≤: ' + err.message);
    }
  }

  function createRoleCard(role, docId) {
    const card = document.createElement('div');
    card.className = `role-card ${role.warnings > 0 && !role.warningsDisabled ? 'warning' : ''}`;
    
    const openLink = (url) => {
      if (url) {
        window.open(url, '_blank', 'noopener,noreferrer');
      }
    };

    const maxWarn = role.maxWarnings || 3;
    const currentWarn = role.warnings || 0;

    card.innerHTML = `
      <div class="role-title">${role.role}</div>
      <div class="nickname">${role.nickname}</div>
      <div class="links">
        ${role.link1 ? `<button type="button" class="link-btn" data-url="${role.link1}">–°–∞–π—Ç</button>` : ''}
        ${role.link2 ? `<button type="button" class="link-btn" data-url="${role.link2}">–°—Ç–∏–º</button>` : ''}
        ${role.link3 ? `<button type="button" class="link-btn" data-url="${role.link3}">–¢–ì</button>` : ''}
      </div>
      <div class="warnings-line">
        ${!role.warningsDisabled ? `
  <div class="warnings-line">
    ${currentUser ? `
      <button class="link-btn" style="padding:4px 6px; font-size:12px;" data-id="${docId}" data-delta="-1">‚Äì</button>
    ` : ''}
    <span class="current-warnings">${currentWarn}</span> / <span class="max-warnings">${maxWarn}</span>
    ${currentUser ? `
      <button class="link-btn" style="padding:4px 6px; font-size:12px;" data-id="${docId}" data-delta="1">+</button>
    ` : ''}
    ${currentUser ? `
      <button class="link-btn" style="margin-left:auto; padding:4px 8px; font-size:12px;">${role.onLeave ? '–í –æ—Ç–ø—É—Å–∫–µ' : '–†–∞–±–æ—Ç–∞–µ—Ç'}</button>
    ` : ''}
  </div>
` : ''}

    card.querySelectorAll('.link-btn[data-url]').forEach(btn => {
      btn.addEventListener('click', () => openLink(btn.dataset.url));
    });

    if (currentUser) {
      card.querySelectorAll('.link-btn[data-delta]').forEach(btn => {
        btn.addEventListener('click', () => {
          const delta = parseInt(btn.dataset.delta);
          incrementWarnings(docId, delta);
        });
      });

      const editBtn = card.querySelector('.edit-btn');
      editBtn.addEventListener('click', () => openEditModal(docId, role));
      
      const statusBtn = card.querySelector('.link-btn:last-of-type:not([data-url]):not([data-delta])');
      if (statusBtn) {
        statusBtn.addEventListener('click', async () => {
          const newStatus = !role.onLeave;
          try {
            await updateDoc(doc(db, "roles", docId), { onLeave: newStatus });
            role.onLeave = newStatus;
            renderRoles();
          } catch (err) {
            alert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + err.message);
          }
        });
      }
    }

    return card;
  }

  searchInput.addEventListener('input', renderRoles);
  warningsFilter.addEventListener('change', renderRoles);

  addBtn.addEventListener('click', () => {
    editingDocId = null;
    modalTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å';
    roleForm.reset();
    document.getElementById('maxWarnings').value = 3;
    toggleWarningsBtn.textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å –≤—ã–≥–æ–≤–æ—Ä—ã';
    document.getElementById('warnings').disabled = false;
    deleteBtn.style.display = 'none';
    modal.classList.add('active');
  });

  function openEditModal(docId, role) {
    editingDocId = docId;
    document.getElementById('roleSelect').value = role.role;
    document.getElementById('nickname').value = role.nickname || '';
    document.getElementById('link1').value = role.link1 || '';
    document.getElementById('link2').value = role.link2 || '';
    document.getElementById('link3').value = role.link3 || '';
    document.getElementById('warnings').value = role.warnings || 0;
    document.getElementById('maxWarnings').value = role.maxWarnings || 3;
    
    const isDisabled = role.warningsDisabled === true;
    toggleWarningsBtn.textContent = isDisabled ? '–í–∫–ª—é—á–∏—Ç—å –≤—ã–≥–æ–≤–æ—Ä—ã' : '–û—Ç–∫–ª—é—á–∏—Ç—å –≤—ã–≥–æ–≤–æ—Ä—ã';
    document.getElementById('warnings').disabled = isDisabled;

    modalTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    deleteBtn.style.display = 'block';
    modal.classList.add('active');
  }

  toggleWarningsBtn.addEventListener('click', () => {
    const warningsInput = document.getElementById('warnings');
    const isNowDisabled = warningsInput.disabled;
    
    if (isNowDisabled) {
      // –í–∫–ª—é—á–∞–µ–º
      warningsInput.disabled = false;
      toggleWarningsBtn.textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å –≤—ã–≥–æ–≤–æ—Ä—ã';
    } else {
      // –û—Ç–∫–ª—é—á–∞–µ–º
      warningsInput.disabled = true;
      warningsInput.value = 0;
      toggleWarningsBtn.textContent = '–í–∫–ª—é—á–∏—Ç—å –≤—ã–≥–æ–≤–æ—Ä—ã';
    }
  });

  closeModal.onclick = () => modal.classList.remove('active');
  window.onclick = (e) => {
    if (e.target === modal) modal.classList.remove('active');
    if (e.target === loginModal) loginModal.classList.remove('active');
  };

  authBtn.onclick = () => {
    if (currentUser) {
      signOut(auth);
    } else {
      loginModal.classList.add('active');
    }
  };

  loginForm.onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
      loginModal.classList.remove('active');
      loginForm.reset();
    } catch (err) {
      alert('–û—à–∏–±–∫–∞: ' + err.message);
    }
  };

  roleForm.onsubmit = async (e) => {
    e.preventDefault();

    const link1 = document.getElementById('link1').value.trim();
    const link2 = document.getElementById('link2').value.trim();
    const link3 = document.getElementById('link3').value.trim();

    const data = {
  role: document.getElementById('roleSelect').value,
  nickname: document.getElementById('nickname').value.trim(),
  link1,
  link2,
  link3,
  warnings: parseInt(document.getElementById('warnings').value) || 0,
  maxWarnings: parseInt(document.getElementById('maxWarnings').value) || 3,
  warningsDisabled: document.getElementById('warnings').disabled,
  ...(editingDocId ? {} : { createdAt: new Date() })
    };

    try {
      if (editingDocId) {
        await updateDoc(doc(db, "roles", editingDocId), data);
      } else {
        await addDoc(collection(db, "roles"), data);
      }
      modal.classList.remove('active');
      roleForm.reset();
      await loadAndRenderRoles();
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
    }
  };

  deleteBtn.onclick = async () => {
    if (!editingDocId) return;
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–æ–ª—å?')) return;

    try {
      await deleteDoc(doc(db, "roles", editingDocId));
      modal.classList.remove('active');
      await loadAndRenderRoles();
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
    }
  };

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
      addBtn.classList.add('visible');
    } else {
      addBtn.classList.remove('visible');
    }
    loadAndRenderRoles();
  });

  if (!isOnline()) {
    loadAndRenderRoles();
  }

  document.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    location.reload();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'F12') {
      e.preventDefault();
      location.reload();
    }
    if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i')) {
      e.preventDefault();
      location.reload();
    }
    if ((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 'U')) {
      e.preventDefault();
      location.reload();
    }
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'J' || e.key === 'j')) {
      e.preventDefault();
      location.reload();
    }
  });

  let devtools = false;
  const threshold = 160;

  setInterval(() => {
    if (window.outerHeight - window.innerHeight > threshold || 
        window.outerWidth - window.innerWidth > threshold) {
      if (!devtools) {
        devtools = true;
        window.open(location.href, '_blank');
        setTimeout(() => location.reload(), 100);
      }
    } else {
      devtools = false;
    }
  }, 1000);
</script>

</body>
</html>


