<!DOCTYPE html>
<html lang="ru">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Состав Админов</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #050a14;
      --bg-gradient: radial-gradient(circle at 50% 0%, #1a2c4e 0%, #050a14 100%);
      
      --card-bg: rgba(20, 30, 50, 0.6);
      --card-border: rgba(255, 255, 255, 0.08);
      --card-hover: rgba(30, 45, 75, 0.8);
      
      --text-main: #ffffff;
      --text-muted: #94a3b8;
      
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.5);
      
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      
      --radius: 16px;
      --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

    body {
      min-height: 100vh;
      background: var(--bg-dark);
      background-image: var(--bg-gradient);
      color: var(--text-main);
      padding: 20px;
      overflow-x: hidden;
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

    .icon {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    .header {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-bottom: 20px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    .btn-circle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
      overflow: hidden;
    }

@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

    .btn-circle:hover {
      background: var(--card-hover);
      color: var(--text-main);
      transform: translateY(-2px);
      border-color: var(--accent);
      box-shadow: 0 0 15px var(--accent-glow);
    }
    
    .btn-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .controls-wrapper {
      max-width: 600px;
      margin: 0 auto 30px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-wrapper {
      position: relative;
    }

    .input-wrapper .icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }

    input[type="text"], select, input[type="email"], input[type="password"], input[type="number"], input[type="url"] {
      width: 100%;
      padding: 12px 14px 12px 44px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: 0.2s;
    }
    
    form input, form select { padding-left: 14px; }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      background: rgba(0, 0, 0, 0.4);
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      padding: 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.02);
      border: 1px solid transparent;
      transition: 0.2s;
    }
    .checkbox-wrapper:hover {
      background: rgba(255,255,255,0.05);
      border-color: var(--card-border);
    }
    .checkbox-wrapper input {
      accent-color: var(--accent);
      width: 16px;
      height: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      max-width: 900px;
      margin: 0 auto 30px;
    }
    
    .stat-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      backdrop-filter: blur(12px);
      padding: 16px;
      border-radius: var(--radius);
      text-align: center;
      box-shadow: var(--shadow);
    }
    
    .stat-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; margin-bottom: 4px; }
    .stat-value { font-size: 24px; font-weight: 800; color: var(--text-main); }
    
    @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } }

    .hierarchy {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .role-section {
      animation: slideUp 0.5s ease forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    .section-header {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent);
      border-left: 3px solid var(--accent);
      color: var(--accent);
      font-weight: 800;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      border-radius: 0 8px 8px 0;
    }

    .cards-container {
      display: grid;
      gap: 16px;
    }

    .role-card {
      position: relative;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 20px;
      backdrop-filter: blur(12px);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform-style: preserve-3d;
    }

    .role-card:hover {
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-2px);
      box-shadow: 0 15px 40px -10px rgba(0,0,0,0.6);
    }
    
    .role-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 4px;
      background: var(--role-color, var(--text-muted));
      opacity: 0.8;
    }

    .role-card.disabled { opacity: 0.5; filter: grayscale(1); }
    .role-card.warning-active { border-color: rgba(245, 158, 11, 0.4); background: rgba(30, 20, 10, 0.6); }

    .role-name {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--role-color, var(--text-muted));
      margin-bottom: 6px;
      transform: translateZ(20px);
    }

    .nickname {
      font-size: 20px;
      font-weight: 900;
      color: var(--text-main);
      margin-bottom: 0px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      transform: translateZ(30px);
    }

    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: auto;
      position: relative;
      padding-top: 20px;
      z-index: 20;
      transform: translateZ(25px);
    }

    .action-btn {
      padding: 6px 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--card-border);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .action-btn:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text-main);
      border-color: rgba(255,255,255,0.2);
    }

    .status-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--card-border);
      z-index: 20; 
      transition: all 0.2s ease;
      transform: translateZ(20px);
    }
    
    .status-badge.clickable:hover {
      transform: scale(1.05) translateZ(20px);
      filter: brightness(1.2);
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    .status-badge.vacation { color: var(--warning); border-color: rgba(245, 158, 11, 0.3); }
    .status-badge.working { color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
    
    .warnings-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 10px;
      padding: 6px 10px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      color: var(--danger);
      font-size: 12px;
      font-weight: 700;
      transform: translateZ(20px);
    }
    .warnings-badge.clean {
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
      color: var(--success);
    }

    .edit-hint {
      position: absolute;
      inset: 0;
      background: rgba(5, 10, 20, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: 0.2s;
      cursor: pointer;
      z-index: 10;
      transform: translateZ(50px);
    }
    .role-card.editable:hover .edit-hint { opacity: 1; }
    .edit-btn {
      background: var(--accent);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 0 20px var(--accent-glow);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: 0.3s;
    }
    .modal.active { opacity: 1; visibility: visible; }
    
    .modal-content {
      background: #111827;
      border: 1px solid var(--card-border);
      width: 95%;
      max-width: 480px;
      padding: 24px;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 20px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-modal {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
    }
    .close-modal:hover { color: var(--text-main); }

    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
    
    .btn-primary {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .btn-primary:hover { filter: brightness(1.1); box-shadow: 0 0 20px var(--accent-glow); }
    
    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.3);
      margin-top: 10px;
    }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

    .fab-add {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      border: none;
      box-shadow: 0 10px 25px var(--accent-glow);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 50;
      opacity: 0;
      transform: scale(0);
    }
    .fab-add.visible { opacity: 1; transform: scale(1); }
    .fab-add:hover { transform: scale(1.1); }

    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .notification {
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      border-left: 4px solid var(--accent);
      padding: 14px;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      color: var(--text-main);
      min-width: 300px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.3s ease;
    }
.pie-chart {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  
  background: conic-gradient(var(--c) calc(var(--p) * 1%), rgba(255, 255, 255, 0.1) 0);
  
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
  transition: 0.3s;
}

.pie-chart::after {
  content: '';
  position: absolute;
  width: 48px;
  height: 48px;
  background: #151e32;
  border-radius: 50%;
  z-index: 1;
}

.chart-content {
  position: relative;
  z-index: 2; 
  font-size: 16px;
  font-weight: 800;
  color: var(--text-main);
}
    .notification.success { border-color: var(--success); }
    .notification.error { border-color: var(--danger); }
    
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
  </style>
</head>

<body>

  <div class="header">
    <div class="notification-container" id="notificationContainer"></div>
    
    <div class="btn-circle" id="rulesBtn" title="Правила">
      <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
    </div>

    <div class="btn-circle" id="logsBtn" title="История действий" style="display:none">
      <svg class="icon" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>
    </div>

    <div class="btn-circle" id="authBtn" title="Авторизация">
      <img src="https://i.postimg.cc/bw6qvcFL/Bez_imeni-2.png" id="userAvatarImg" alt="User" style="display:none">
      <svg class="icon" id="userAvatarIcon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
    </div>
  </div>

  <div class="controls-wrapper">
    <div class="input-wrapper">
      <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <input type="text" id="searchInput" placeholder="Поиск администратора...">
    </div>

    <label class="checkbox-wrapper">
      <input type="checkbox" id="warningsFilter">
      <span>Показать только с выговорами</span>
    </label>
  </div>

  <div id="offlineBanner" style="display:none; text-align:center; padding:10px; background:rgba(239,68,68,0.2); color:#fca5a5; border-radius:12px; margin-bottom:20px;">
    <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
      <svg class="icon" viewBox="0 0 24 24"><path d="M1 1l22 22"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>
      <span>Нет подключения. Показан кэш.</span>
    </div>
  </div>

  <div class="stats-grid" id="stats">
  </div>

  <div class="hierarchy" id="hierarchyContainer">
  </div>

  <button class="fab-add" id="addBtn">
    <svg class="icon" style="width:28px; height:28px;" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
  </button>

  <div class="modal" id="rulesModal">
    <div class="modal-content">
      <button class="close-modal">
        <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <div class="modal-title">
        <svg class="icon" style="color:var(--accent)" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg>
        Правила Администрации
      </div>
      <div style="line-height:1.6; color:var(--text-muted); font-size:14px;">
        <p style="margin-bottom:10px;">• Отсутствие 7 дней = <span style="color:var(--danger)">1 выговор</span></p>
        <p style="margin-bottom:10px;">• Нарушение правил = <span style="color:var(--danger)">2 варна</span></p>
        <p style="margin-bottom:10px;">• Отыграй 7+ часов, чтобы снять варн (1ч = -1 варн).</p>
        <p style="margin-bottom:10px;">• 1 Выговор = 3 Варна.</p>
        <div style="margin-top:20px; padding:10px; background:rgba(59,130,246,0.1); border-left:3px solid var(--accent); color:var(--text-main);">
          Обязательно к ознакомлению перед началом работы!
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="logsModal">
    <div class="modal-content">
      <button class="close-modal">
        <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <div class="modal-title">
        <svg class="icon" style="color:var(--accent)" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        История изменений
      </div>
      <div id="logsList" style="display:flex; flex-direction:column; gap:10px; max-height:400px; overflow-y:auto; padding-right:5px;">
        <div style="text-align:center; color:var(--text-muted)">Загрузка...</div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <button class="close-modal" id="closeEditor">
        <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <h2 class="modal-title" id="modalTitle">Редактировать</h2>
      <form id="roleForm">
        <div class="form-group">
          <label>Роль</label>
          <select id="roleSelect" required>
            <option value="Владелец">Владелец</option>
            <option value="Совладелец">Совладелец</option>
            <option value="Руководство">Руководство</option>
            <option value="Куратор">Куратор</option>
            <option value="Гл. Админ">Гл. Админ</option>
            <option value="Зам.Га">Зам.Га</option>
            <option value="Покупной Админ">Покупной Админ</option>
            <option value="Админ 2лвл">Админ 2лвл</option>
            <option value="Админ 1лвл">Админ 1лвл</option>
            <option value="Стажер">Стажер</option>
          </select>
        </div>

        <div class="form-group">
          <label>Никнейм</label>
          <input type="text" id="nickname" required placeholder="Например: Не придумал">
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
          <div class="form-group">
            <label>Сайт (URL)</label>
            <input type="url" id="link1">
          </div>
          <div class="form-group">
            <label>Steam (URL)</label>
            <input type="url" id="link2">
          </div>
          <div class="form-group">
            <label>Telegram (URL)</label>
            <input type="url" id="link3">
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; background:rgba(0,0,0,0.2); padding:10px; border-radius:12px; margin-bottom:16px;">
          <div class="form-group" style="margin:0;">
            <label>Выдано Варнов</label>
            <input type="number" id="warningsIssued" min="0" max="999" value="0">
          </div>
          <div class="form-group" style="margin:0;">
            <label>Лимит Варнов</label>
            <input type="number" id="warningsMax" min="1" max="999" value="3">
          </div>
        </div>

        <label class="checkbox-wrapper" style="margin-bottom:20px; justify-content:flex-start;">
          <input type="checkbox" id="disabled">
          <span>Отключить выговоры</span>
        </label>

        <button type="submit" class="btn-primary">
          <svg class="icon" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
          Сохранить
        </button>
        <button type="button" id="deleteBtn" class="btn-primary btn-danger" style="display:none;">
          <svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
          Удалить
        </button>
      </form>
    </div>
  </div>

  <div class="modal" id="loginModal">
    <div class="modal-content">
      <button class="close-modal" id="closeLogin">
        <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <h2 class="modal-title">Вход</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label>Пароль</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn-primary">Войти</button>
      </form>
    </div>
  </div>

<div class="modal" id="logoutModal">
    <div class="modal-content" style="max-width: 320px; text-align: center;">
      <div style="margin-bottom: 15px; color: var(--danger);">
        <svg class="icon" style="width:48px; height:48px;" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
      </div>
      <h3 style="color:var(--text-main); margin-bottom: 8px; font-size: 18px;">Выход из аккаунта</h3>
      <p style="color:var(--text-muted); font-size: 14px; margin-bottom: 20px;">
        Ты уверен, что хочешь выйти?
      </p>
      <div style="display: flex; gap: 10px;">
        <button id="cancelLogoutBtn" class="btn-primary" style="background: rgba(255,255,255,0.1); border: 1px solid var(--card-border);">Отмена</button>
        <button id="confirmLogoutBtn" class="btn-primary btn-danger" style="margin-top:0;">Выйти</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdVnWilNkGMkf7BQZmGLuVpEqUTPLjIj0",
      authDomain: "adminsostav.firebaseapp.com",
      projectId: "adminsostav",
      storageBucket: "adminsostav.firebasestorage.app",
      messagingSenderId: "403848315485",
      appId: "1:403848315485:web:16a857b3972ee8b6b503b4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ROLE_PRIORITY = {
      "Владелец": 1,
      "Совладелец": 2,
      "Руководство": 3,
      "Куратор": 4,
      "Гл. Админ": 5,
      "Зам.Га": 6,
      "Покупной Админ": 7,
      "Админ 2лвл": 8,
      "Админ 1лвл": 9,
      "Стажер": 10
    };
    
    const ROLE_COLORS = {
      "Владелец": "#ef4444", 
      "Совладелец": "#f97316", 
      "Руководство": "#eab308",
      "Куратор": "#e11d48",
      "Гл. Админ": "#84cc16",
      "Зам.Га": "#10b981", 
      "Покупной Админ": "#06b6d4", 
      "Админ 2лвл": "#3b82f6", 
      "Админ 1лвл": "#8b5cf6", 
      "Стажер": "#d946ef"
    };

    const hierarchyContainer = document.getElementById('hierarchyContainer');
    const statsContainer = document.getElementById('stats');
    const addBtn = document.getElementById('addBtn');
    const authBtn = document.getElementById('authBtn');
    const rulesBtn = document.getElementById('rulesBtn');
    
    const modal = document.getElementById('modal');
    const loginModal = document.getElementById('loginModal');
    const rulesModal = document.getElementById('rulesModal');
    
    const roleForm = document.getElementById('roleForm');
    const loginForm = document.getElementById('loginForm');
    
    let currentUser = null;
    let editingDocId = null;
    let allRoles = [];
    const CACHE_KEY = 'roles_cache_v2';

    // Функция записи лога в базу
    async function addLog(action, details) {
      if (!currentUser) return;
      try {
        await addDoc(collection(db, "logs"), {
          admin: currentUser.email,
          action: action,
          details: details,
          timestamp: new Date().toISOString()
        });
      } catch (e) {
        console.error("Ошибка логгирования:", e);
      }
    }

    function showNotification(title, message, type = 'info') {
      const container = document.getElementById('notificationContainer');
      const div = document.createElement('div');
      div.className = `notification ${type}`;
      
      let iconSvg = '';
      if(type === 'success') iconSvg = '<svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>';
      else if(type === 'error') iconSvg = '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
      else iconSvg = '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';

      div.innerHTML = `
        <div style="color:${type === 'success' ? 'var(--success)' : (type==='error'?'var(--danger)':'var(--accent)')}">${iconSvg}</div>
        <div>
          <div style="font-weight:700; font-size:14px;">${title}</div>
          <div style="font-size:12px; color:var(--text-muted);">${message}</div>
        </div>
      `;
      
      container.appendChild(div);
      setTimeout(() => div.remove(), 4000);
    }

    async function loadRoles() {
      if (navigator.onLine) {
        try {
          const q = query(collection(db, "roles"), orderBy("createdAt", "asc"));
          const snapshot = await getDocs(q);
          allRoles = [];
          snapshot.forEach(d => allRoles.push({ id: d.id, ...d.data() }));
          localStorage.setItem(CACHE_KEY, JSON.stringify(allRoles));
          document.getElementById('offlineBanner').style.display = 'none';
        } catch (e) {
          console.error(e);
          allRoles = JSON.parse(localStorage.getItem(CACHE_KEY) || '[]');
          showNotification('Ошибка', 'Не удалось загрузить данные', 'error');
        }
      } else {
        allRoles = JSON.parse(localStorage.getItem(CACHE_KEY) || '[]');
        document.getElementById('offlineBanner').style.display = 'block';
      }
      renderRoles();
    }

    function renderRoles() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const onlyWarns = document.getElementById('warningsFilter').checked;

      const filtered = allRoles.filter(r => {
        const matchesSearch = r.nickname.toLowerCase().includes(search);
        const hasWarns = (r.warningsIssued || 0) > 0;
        return matchesSearch && (!onlyWarns || hasWarns);
      });

      const total = filtered.length;
      const vacation = filtered.filter(r => r.onVacation).length;
      const warned = filtered.filter(r => (r.warningsIssued || 0) > 0 && !r.disabled).length;

      const percentVacation = total > 0 ? Math.round((vacation / total) * 100) : 0;
      const percentWarned = total > 0 ? Math.round((warned / total) * 100) : 0;

      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="pie-chart" style="--p:100; --c:var(--accent)">
            <span class="chart-content">${total}</span>
          </div>
          <div class="stat-label">Всего</div>
        </div>
        <div class="stat-card">
          <div class="pie-chart" style="--p:${percentVacation}; --c:var(--warning)">
             <span class="chart-content">${vacation}</span>
          </div>
          <div class="stat-label">В отпуске</div>
        </div>
        <div class="stat-card">
          <div class="pie-chart" style="--p:${percentWarned}; --c:var(--danger)">
             <span class="chart-content">${warned}</span>
          </div>
          <div class="stat-label">Нарушители</div>
        </div>
      `;

      hierarchyContainer.innerHTML = '';
      if(filtered.length === 0) {
        hierarchyContainer.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding: 20px;">Никого не найдено...</div>';
        return;
      }

      const grouped = {};
      filtered.forEach(r => {
        if(!grouped[r.role]) grouped[r.role] = [];
        grouped[r.role].push(r);
      });

      const sortedKeys = Object.keys(grouped).sort((a,b) => (ROLE_PRIORITY[a]||99) - (ROLE_PRIORITY[b]||99));

      sortedKeys.forEach((roleName, idx) => {
        const section = document.createElement('div');
        section.className = 'role-section';
        section.style.animationDelay = `${idx * 0.1}s`;

        const color = ROLE_COLORS[roleName] || '#94a3b8';

        section.innerHTML = `
            <div class="section-header" style="color:${color}; border-color:${color}; background: linear-gradient(90deg, ${color}15, transparent)">
                ${roleName}
            </div>
        `;
        
        const cardsDiv = document.createElement('div');
        cardsDiv.className = 'cards-container';
        
        grouped[roleName].forEach(role => {
          cardsDiv.appendChild(createCard(role, color));
        });

        section.appendChild(cardsDiv);
        hierarchyContainer.appendChild(section);
      });

      if (typeof VanillaTilt !== "undefined") {
        VanillaTilt.init(document.querySelectorAll(".role-card"), {
          max: 15,
          speed: 400,
          glare: true,
          "max-glare": 0.2,
          scale: 1.05
        });
      }
    } 

    function createCard(role, color) {
      const div = document.createElement('div');
      const warns = role.warningsIssued || 0;
      const max = role.warningsMax || 3;
      
      div.className = `role-card ${role.disabled ? 'disabled' : ''} ${currentUser ? 'editable' : ''}`;
      div.style.setProperty('--role-color', color);

      const linkIcon = '<svg class="icon" style="width:14px; height:14px;" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>';

      div.innerHTML = `
        <div class="status-badge ${role.onVacation ? 'vacation' : 'working'} ${currentUser ? 'clickable' : ''} vacation-toggle" title="Нажми для смены" style="cursor:${currentUser ? 'pointer' : 'default'}">
          ${role.onVacation 
            ? '<svg class="icon" style="width:14px" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> Отпуск' 
            : '<svg class="icon" style="width:14px" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg> Работает'}
        </div>

        <div class="role-name">${role.role}</div>
        <div class="nickname">${role.nickname}</div>

        ${!role.disabled ? `
          <div class="warnings-badge ${warns === 0 ? 'clean' : ''}">
             ${warns > 0 ? '<svg class="icon" style="width:14px" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>' : '<svg class="icon" style="width:14px" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>'}
             ${warns} / ${max}
          </div>
        ` : ''}

        <div class="card-actions">
          ${role.link1 ? `<a href="${role.link1}" target="_blank" class="action-btn">${linkIcon} Сайт</a>` : ''}
          ${role.link2 ? `<a href="${role.link2}" target="_blank" class="action-btn">${linkIcon} Steam</a>` : ''}
          ${role.link3 ? `<a href="${role.link3}" target="_blank" class="action-btn">${linkIcon} TG</a>` : ''}
        </div>

        ${currentUser ? `
          <div class="edit-hint">
            <div class="edit-btn">
              <svg class="icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
              Редактировать
            </div>
          </div>
        ` : ''}
      `;

      if(currentUser) {
        div.addEventListener('click', (e) => {
          if(!e.target.closest('a') && !e.target.closest('.vacation-toggle')) {
            openEdit(role);
          }
        });

        div.querySelector('.vacation-toggle').addEventListener('click', async (e) => {
          e.stopPropagation();
          try {
            await updateDoc(doc(db, "roles", role.id), { onVacation: !role.onVacation });
            
            addLog(role.onVacation ? "Вернул из отпуска" : "Отправил в отпуск", role.nickname);

            showNotification('Успешно', 'Статус изменен', 'success');
            loadRoles();
          } catch(err) { showNotification('Ошибка', err.message, 'error'); }
        });
      }

      return div;
    }

    function openEdit(role) {
      editingDocId = role.id;
      document.getElementById('modalTitle').textContent = 'Редактировать';
      document.getElementById('roleSelect').value = role.role;
      document.getElementById('nickname').value = role.nickname;
      document.getElementById('link1').value = role.link1 || '';
      document.getElementById('link2').value = role.link2 || '';
      document.getElementById('link3').value = role.link3 || '';
      document.getElementById('warningsIssued').value = role.warningsIssued || 0;
      document.getElementById('warningsMax').value = role.warningsMax || 3;
      document.getElementById('disabled').checked = role.disabled || false;
      document.getElementById('deleteBtn').style.display = 'flex';
      modal.classList.add('active');
    }

    document.querySelectorAll('.close-modal').forEach(btn => {
      btn.onclick = function() {
        this.closest('.modal').classList.remove('active');
      }
    });

    rulesBtn.onclick = () => rulesModal.classList.add('active');

    const logoutModal = document.getElementById('logoutModal');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');

    authBtn.onclick = () => {
      if(currentUser) {
        logoutModal.classList.add('active');
      } else {
        loginModal.classList.add('active');
      }
    };

    confirmLogoutBtn.onclick = () => {
      signOut(auth);
      logoutModal.classList.remove('active');
      showNotification('Выход', 'Вы успешно вышли', 'info');
    };

    cancelLogoutBtn.onclick = () => {
      logoutModal.classList.remove('active');
    };

    addBtn.onclick = () => {
      editingDocId = null;
      roleForm.reset();
      document.getElementById('modalTitle').textContent = 'Добавить сотрудника';
      document.getElementById('deleteBtn').style.display = 'none';
      document.getElementById('warningsIssued').value = 0;
      document.getElementById('warningsMax').value = 3;
      modal.classList.add('active');
    };

    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
        loginModal.classList.remove('active');
        showNotification('Успех', 'Вы вошли в систему', 'success');
      } catch(err) { showNotification('Ошибка входа', err.message, 'error'); }
    };

    roleForm.onsubmit = async (e) => {
      e.preventDefault();
      const data = {
        role: document.getElementById('roleSelect').value,
        nickname: document.getElementById('nickname').value,
        link1: document.getElementById('link1').value,
        link2: document.getElementById('link2').value,
        link3: document.getElementById('link3').value,
        warningsIssued: parseInt(document.getElementById('warningsIssued').value) || 0,
        warningsMax: parseInt(document.getElementById('warningsMax').value) || 3,
        disabled: document.getElementById('disabled').checked,
        onVacation: false,
        createdAt: new Date().toISOString()
      };

      try {
        if(editingDocId) {
           await updateDoc(doc(db, "roles", editingDocId), data);
           addLog("Редактировал", data.nickname);
           showNotification('Обновлено', 'Данные сотрудника сохранены', 'success');
        } else {
           await addDoc(collection(db, "roles"), data);
           addLog("Создал", data.nickname);
           showNotification('Создано', 'Новый сотрудник добавлен', 'success');
        }
        modal.classList.remove('active');
        loadRoles();
      } catch(err) { showNotification('Ошибка', err.message, 'error'); }
    };

    document.getElementById('deleteBtn').onclick = async () => {
      if(confirm('Удалить этого сотрудника навсегда?')) {
        try {
          const nick = document.getElementById('nickname').value;
          
          await deleteDoc(doc(db, "roles", editingDocId));
          
          addLog("Удалил", nick);

          modal.classList.remove('active');
          showNotification('Удалено', 'Сотрудник удален', 'success');
          loadRoles();
        } catch(err) { showNotification('Ошибка', err.message, 'error'); }
      }
    };

    const logsBtn = document.getElementById('logsBtn');
    const logsModal = document.getElementById('logsModal');
    const logsList = document.getElementById('logsList');

    logsBtn.onclick = async () => {
      logsModal.classList.add('active');
      logsList.innerHTML = '<div style="text-align:center; color:var(--text-muted)">Загрузка...</div>';
      
      try {
        const q = query(collection(db, "logs"), orderBy("timestamp", "desc")); 
        
        const snapshot = await getDocs(q);
        logsList.innerHTML = '';

        if (snapshot.empty) {
            logsList.innerHTML = '<div style="text-align:center; color:var(--text-muted)">История пуста</div>';
            return;
        }

        snapshot.forEach(doc => {
          const log = doc.data();
          const date = new Date(log.timestamp).toLocaleString('ru-RU');
          
          const item = document.createElement('div');
          item.style.cssText = 'background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; font-size:13px; border-left: 2px solid var(--text-muted);';
          
          let color = '#94a3b8';
          if(log.action.includes('Удалил')) color = '#ef4444';
          if(log.action.includes('Создал')) color = '#10b981';
          if(log.action.includes('Редактировал')) color = '#3b82f6';
          if(log.action.includes('отпуск')) color = '#f59e0b';
          
          item.style.borderColor = color;
          
          item.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <strong style="color:var(--text-main)">${log.action}: ${log.details}</strong>
                <span style="font-size:11px; color:var(--text-muted)">${date}</span>
            </div>
            <div style="font-size:11px; color:var(--text-muted);">
                Админ: ${log.admin}
            </div>
          `;
          logsList.appendChild(item);
        });
        
      } catch (e) {
        console.error(e);
        logsList.innerHTML = '<div style="color:var(--danger)">Нужен индекс в Firebase (см. консоль) или ошибка сети</div>';
      }
    };

    document.getElementById('searchInput').addEventListener('input', renderRoles);
    document.getElementById('warningsFilter').addEventListener('change', renderRoles);

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      const avatarImg = document.getElementById('userAvatarImg');
      const avatarIcon = document.getElementById('userAvatarIcon');

      if(user) {
        addBtn.classList.add('visible');
        logsBtn.style.display = 'flex';
        avatarImg.style.display = 'block';
        avatarIcon.style.display = 'none';
      } else {
        addBtn.classList.remove('visible');
        logsBtn.style.display = 'none';
        avatarImg.style.display = 'none';
        avatarIcon.style.display = 'block';
      }
      loadRoles();
    });

    loadRoles();
  
  </script>

</body>
</html>

