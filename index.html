<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–æ—Å—Ç–∞–≤ –ê–¥–º–∏–Ω–æ–≤</title>
  <style>
.rules-btn {
  width: 40px; 
  height: 40px; 
  border-radius: 50%;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center; 
  cursor: pointer;
  margin-right: 10px;
}

.rules-btn img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

.rules-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.rules-modal.active {
  opacity: 1;
  visibility: visible;
}

.rules-content {
  background: var(--card-bg);
  padding: 25px;
  border-radius: 15px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  border: 2px solid var(--accent);
}

.rules-title {
  font-size: 22px;
  font-weight: bold;
  margin-bottom: 20px;
  color: var(--accent);
  text-align: center;
}

.rules-text {
  font-size: 15px;
  line-height: 1.6;
  margin-bottom: 25px;
  color: var(--text);
}
.notification-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 400px;
}

.notification {
  background: var(--card-bg);
  border: 1px solid;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  transform: translateX(400px);
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  display: flex;
  align-items: flex-start;
  gap: 12px;
  max-height: 0;
  overflow: hidden;
}

.notification.show {
  transform: translateX(0);
  opacity: 1;
  max-height: 200px;
}

.notification.hide {
  transform: translateX(400px);
  opacity: 0;
  max-height: 0;
  margin: 0;
  padding-top: 0;
  padding-bottom: 0;
}

.notification.success {
  border-color: #2ecc71;
  background: rgba(46, 204, 113, 0.1);
}

.notification.error {
  border-color: var(--danger);
  background: rgba(247, 37, 133, 0.1);
}

.notification.warning {
  border-color: #f39c12;
  background: rgba(243, 156, 18, 0.1);
}

.notification.info {
  border-color: var(--accent);
  background: rgba(76, 201, 240, 0.1);
}

.notification-icon {
  font-size: 20px;
  flex-shrink: 0;
  margin-top: 2px;
}

.notification-content {
  flex: 1;
}

.notification-title {
  font-weight: bold;
  margin-bottom: 4px;
  font-size: 15px;
}

.notification-message {
  font-size: 14px;
  line-height: 1.4;
  color: rgba(230, 230, 255, 0.9);
}

.notification-close {
  background: none;
  border: none;
  color: var(--text);
  font-size: 18px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  flex-shrink: 0;
  margin-top: 2px;
}

.notification-close:hover {
  background: rgba(255, 255, 255, 0.1);
}
.role-section > div {
  display: flex;
  flex-direction: column;
  gap: 12px; /* –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ */
}
.links {
  display: flex;
  gap: 6px;
  margin: 10px 0;
  justify-content: flex-start;
  flex-wrap: wrap;
}

.link-btn {
  background: transparent;
  border: 1px solid var(--accent);
  color: var(--text);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  text-decoration: none;
  outline: none;
  transition: all 0.2s ease;
  white-space: nowrap;
  width: fit-content;
}

.link-btn:hover {
  background: rgba(76, 201, 240, 0.15);
  color: var(--accent);
}
    :root {
      --bg: #0f0f1b;
      --card-bg: #1a1a2e;
      --text: #e6e6ff;
      --accent: #4cc9f0;
      --danger: #f72585;
      --warning-bg: rgba(247, 37, 133, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }
    .header { display: flex; justify-content: flex-end; padding: 12px 0; }
    .avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: transparent;; display: flex; align-items: center;
      justify-content: center; cursor: pointer;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .add-btn {
  position: fixed; bottom: 24px; right: 24px;
  width: 56px; height: 56px; border-radius: 50%;
  background: transparent; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω */
  font-size: 26px; display: flex; align-items: center;
  justify-content: center; cursor: pointer;
  box-shadow: none; /* –£–±–∏—Ä–∞–µ–º —Ç–µ–Ω—å */
  opacity: 0; visibility: hidden; transform: scale(0);
  transition: all 0.3s ease; z-index: 10;
  border: none;
  background-image: url('https://i.postimg.cc/L4VzQSHW/3d-plus-dynamic-gradient-icon-1082964-122.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}
    .add-btn.visible {
      opacity: 1; visibility: visible; transform: scale(1);
    }
    .search-box {
      text-align: center;
      margin: 16px 0;
    }
    .search-box input,
    .filter-box input {
      padding: 10px;
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      background: #2d2d44;
      color: var(--text);
      border: 1px solid #444;
      outline: none;
    }
    .filter-box {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filter-box label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: var(--text);
    }
    .hierarchy {
      display: flex; flex-direction: column; gap: 16px;
      max-width: 800px; margin: 0 auto;
    }
    .role-section {
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 12px;
      color: var(--accent);
      padding-bottom: 6px;
      border-bottom: 1px solid var(--accent);
    }
    .role-card {
      background: var(--card-bg); border-radius: 12px;
      padding: 18px; position: relative;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.4s forwards;
      transition: all 0.3s ease;
      cursor: default;
    }
    .role-card.editable {
      cursor: pointer;
    }
    .role-card.editable:hover {
      background: #1f1f38;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      transform: translateY(-2px);
    }
    .edit-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(76, 201, 240, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    .role-card.editable:hover .edit-overlay {
      opacity: 1;
    }
    .edit-text {
      color: var(--accent);
      font-weight: bold;
      font-size: 18px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    @keyframes fadeIn {
      to { opacity: 1; transform: translateY(0); }
    }
    .role-card.disabled { opacity: 0.6; }
    .role-card.warning { background: var(--warning-bg); }
    .role-title { font-size: 17px; font-weight: bold; margin-bottom: 6px; color: var(--accent); }
    .nickname { font-size: 19px; margin-bottom: 10px; }
    .links { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
    .link { color: var(--text); text-decoration: underline; font-size: 14px; }
    .link:hover { color: var(--accent); }
    
    .warnings-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--danger);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.3s ease;
    }
    
    .warnings-badge.no-warnings {
      background: #2ecc71;
    }
    
    .edit-btn {
      position: absolute; top: 10px; right: 10px;
      background: rgba(255,255,255,0.1); border: none;
      color: var(--accent); width: 28px; height: 28px;
      border-radius: 50%; cursor: pointer;
      opacity: 0; visibility: hidden;
    }
    .role-card:hover .warnings-badge {
      top: 10px;
    }
    
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex;
      align-items: center; justify-content: center;
      z-index: 100; opacity: 0; visibility: hidden;
      transition: all 0.3s;
    }
    .modal.active {
      opacity: 1; visibility: visible;
    }
    .modal-content {
      background: var(--card-bg); padding: 22px;
      border-radius: 15px; width: 92%; max-width: 500px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h2 {
      margin-bottom: 18px; color: var(--accent); text-align: center;
    }
    .form-group { margin-bottom: 14px; }
    label { display: block; margin-bottom: 5px; font-size: 14px; }
    select, input {
      width: 100%; padding: 10px; border-radius: 8px;
      background: #2d2d44; color: var(--text);
      border: 1px solid #444;
    }
    
    .warnings-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 14px;
    }
    
    .warnings-group .form-group {
      margin-bottom: 0;
    }
    
    .toggle-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      padding: 10px;
      background: #2d2d44;
      border-radius: 8px;
      border: 1px solid #444;
    }
    
    .toggle-label {
      margin-bottom: 0;
      font-weight: bold;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #444;
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--accent);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    button {
      background: var(--accent); color: #0f0f1b;
      border: none; padding: 10px 20px;
      border-radius: 8px; cursor: pointer;
      font-weight: bold; width: 100%; margin-top: 14px;
    }
    #deleteBtn {
      background: var(--danger);
      margin-top: 10px;
      display: none;
    }
    .close-modal {
      position: absolute; top: 12px; right: 12px;
      background: none; border: none; color: var(--text);
      font-size: 22px; cursor: pointer;
      display: none;
    }
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .offline-banner {
      background: var(--danger);
      color: white;
      text-align: center;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 6px;
      font-size: 14px;
    }
    @media (max-width: 600px) {
      body { padding: 12px; }
      .add-btn { bottom: 16px; right: 16px; width: 50px; height: 50px; font-size: 24px; }
      .role-card { padding: 14px; }
      .modal-content { padding: 16px; width: 95%; }
    }
  </style>
</head>
<body>

<div class="header">
<div class="notification-container" id="notificationContainer"></div>
  <div class="avatar" id="authBtn">
    <img src="https://i.postimg.cc/bw6qvcFL/Bez-imeni-2.png" alt="–ê–≤–∞—Ç–∞—Ä" onerror="this.style.display='none'; this.parentElement.innerHTML='üë§'">
  </div>
</div>

<div class="rules-modal" id="rulesModal">
  <div class="rules-content">
    <div class="rules-title">–î–æ–ø –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞</div>
    <div class="rules-text">
      <p>‚Ä¢ –ó–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–∏ –Ω–µ–¥–µ–ª–∏ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 1 –≤—ã–≥–æ–≤–æ—Ä!</p>
      <p>‚Ä¢ –ó–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 2 –≤–∞—Ä–Ω–∞ –Ω–µ –≤–∫–ª—é—á–∞—è –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –±–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞!</p>
      <p>‚Ä¢ –•–æ—Ç–∏—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å –≤—ã–≥–æ–≤–æ—Ä—ã –∏ –≤–∞—Ä–Ω—ã –Ω–∞–∏–≥—Ä—ã–≤–∞–π—Ç–µ –±–æ–ª—å—à–µ 7 —á–∞—Å–æ–≤ (1—á = 1 –≤–∞—Ä–Ω)</p>
      <p>‚Ä¢ 1 –í—ã–≥–æ–≤–æ—Ä = 3 –í–∞—Ä–Ω–∞</p>
      <p style="color: var(--accent); font-weight: bold; margin-top: 15px;">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—é!</p>
    </div>
  </div>
</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É...">
</div>

<div class="filter-box">
  <label><input type="checkbox" id="warningsFilter"> –¢–æ–ª—å–∫–æ —Å –≤—ã–≥–æ–≤–æ—Ä–∞–º–∏</label>
</div>

<div id="offlineBanner" class="offline-banner" style="display:none;">
  ‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –ü–æ–∫–∞–∑–∞–Ω—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
</div>

<div class="hierarchy" id="hierarchyContainer">
  <div style="text-align:center; padding:20px;"><div class="spinner"></div></div>
</div>

<div class="add-btn" id="addBtn"></div>

<div class="modal" id="modal">
  <div class="modal-content">
    <button class="close-modal" id="closeModal">&times;</button>
    <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å</h2>
    <form id="roleForm">
      <div class="form-group">
        <label>–†–æ–ª—å</label>
        <select id="roleSelect" required>
          <option value="–í–ª–∞–¥–µ–ª–µ—Ü">–í–ª–∞–¥–µ–ª–µ—Ü</option>
          <option value="–°–æ–≤–ª–∞–¥–µ–ª–µ—Ü">–°–æ–≤–ª–∞–¥–µ–ª–µ—Ü</option>
          <option value="–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ">–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ</option>
          <option value="–ì–ª. –ê–¥–º–∏–Ω">–ì–ª. –ê–¥–º–∏–Ω</option>
          <option value="–ó–∞–º.–ì–∞">–ó–∞–º.–ì–∞</option>
          <option value="–ü–æ–∫—É–ø–Ω–æ–π –ê–¥–º–∏–Ω">–ü–æ–∫—É–ø–Ω–æ–π –ê–¥–º–∏–Ω</option>
          <option value="–ê–¥–º–∏–Ω 2–ª–≤–ª">–ê–¥–º–∏–Ω 2–ª–≤–ª</option>
          <option value="–ê–¥–º–∏–Ω 1–ª–≤–ª">–ê–¥–º–∏–Ω 1–ª–≤–ª</option>
          <option value="–°—Ç–∞–∂–µ—Ä">–°—Ç–∞–∂–µ—Ä</option>
        </select>
      </div>
      <div class="form-group">
        <label>–ù–∏–∫–Ω–µ–π–º</label>
        <input type="text" id="nickname" required>
      </div>
      <div class="form-group">
        <label>–°–∞–π—Ç</label>
        <input type="url" id="link1" placeholder="https://example.com">
      </div>
      <div class="form-group">
        <label>–°—Ç–∏–º</label>
        <input type="url" id="link2" placeholder="https://steamcommunity.com/id/...">
      </div>
      <div class="form-group">
        <label>–¢–ì</label>
        <input type="url" id="link3" placeholder="https://t.me/...">
      </div>
      
      <div class="warnings-group">
        <div class="form-group">
          <label>–í—ã–¥–∞–Ω–æ –≤—ã–≥–æ–≤–æ—Ä–æ–≤</label>
          <input type="number" id="warningsIssued" min="0" max="999" value="0">
        </div>
        <div class="form-group">
          <label>–ú–∞–∫—Å. –≤—ã–≥–æ–≤–æ—Ä–æ–≤</label>
          <input type="number" id="warningsMax" min="1" max="999" value="3">
        </div>
      </div>
      
      <div class="toggle-group">
        <span class="toggle-label">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
        <label class="toggle-switch">
          <input type="checkbox" id="disabled">
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" id="deleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
    </form>
  </div>
</div>

<div class="modal" id="loginModal">
  <div class="modal-content">
    <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <form id="loginForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" required>
      </div>
      <div class="form-group">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="loginPassword" required>
      </div>
      <button type="submit">–í–æ–π—Ç–∏</button>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCdVnWilNkGMkf7BQZmGLuVpEqUTPLjIj0",
    authDomain: "adminsostav.firebaseapp.com",
    projectId: "adminsostav",
    storageBucket: "adminsostav.firebasestorage.app",
    messagingSenderId: "403848315485",
    appId: "1:403848315485:web:16a857b3972ee8b6b503b4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const ROLE_PRIORITY = {
    "–í–ª–∞–¥–µ–ª–µ—Ü": 1,
    "–°–æ–≤–ª–∞–¥–µ–ª–µ—Ü": 2,
    "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ": 3,
    "–ì–ª. –ê–¥–º–∏–Ω": 4,
    "–ó–∞–º.–ì–∞": 5,
    "–ü–æ–∫—É–ø–Ω–æ–π –ê–¥–º–∏–Ω": 6,
    "–ê–¥–º–∏–Ω 2–ª–≤–ª": 7,
    "–ê–¥–º–∏–Ω 1–ª–≤–ª": 8,
    "–°—Ç–∞–∂–µ—Ä": 9
  };

  const hierarchyContainer = document.getElementById('hierarchyContainer');
  const addBtn = document.getElementById('addBtn');
  const authBtn = document.getElementById('authBtn');
  const modal = document.getElementById('modal');
  const loginModal = document.getElementById('loginModal');
  const closeModal = document.getElementById('closeModal');
  const roleForm = document.getElementById('roleForm');
  const loginForm = document.getElementById('loginForm');
  const modalTitle = document.getElementById('modalTitle');
  const searchInput = document.getElementById('searchInput');
  const deleteBtn = document.getElementById('deleteBtn');
  const warningsFilter = document.getElementById('warningsFilter');
  const offlineBanner = document.getElementById('offlineBanner');

  let currentUser = null;
  let editingDocId = null;
  let allRoles = [];

  const CACHE_KEY = 'roles_cache';
  const CACHE_EXPIRY = 5 * 60 * 1000;

  function showNotification(title, message, type = 'info', duration = 5000) {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icons = {
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      info: '‚ÑπÔ∏è'
    };
    
    notification.innerHTML = `
      <div class="notification-icon">${icons[type]}</div>
      <div class="notification-content">
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
      </div>
      <button class="notification-close">&times;</button>
    `;
    
    container.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 10);
    
    const closeBtn = notification.querySelector('.notification-close');
    closeBtn.addEventListener('click', () => {
      closeNotification(notification);
    });
    
    if (duration > 0) {
      setTimeout(() => {
        if (notification.parentNode) {
          closeNotification(notification);
        }
      }, duration);
    }
    
    return notification;
  }

  function closeNotification(notification) {
    notification.classList.remove('show');
    notification.classList.add('hide');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 400);
  }

  function showOfflineBanner(show = true) {
    offlineBanner.style.display = show ? 'block' : 'none';
  }

  function isOnline() {
    return navigator.onLine;
  }

  function getCachedData() {
    const cached = localStorage.getItem(CACHE_KEY);
    if (!cached) return null;
    const { data, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp > CACHE_EXPIRY) {
      localStorage.removeItem(CACHE_KEY);
      return null;
    }
    return data;
  }

  function setCachedData(data) {
    localStorage.setItem(CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() }));
  }

  function validateURL(value, type) {
    if (!value) return true;
    try {
      const url = new URL(value);
      if (type === 'steam') {
        return url.hostname === 'steamcommunity.com' && url.pathname.startsWith('/id/');
      } else if (type === 'tg') {
        return url.hostname === 't.me' || (url.hostname === 'telegram.me');
      } else {
        return url.protocol === 'https:';
      }
    } catch {
      return false;
    }
  }

  async function loadAndRenderRoles(useCache = true) {
    let data = null;
    let fromCache = false;

    if (isOnline()) {
      try {
        const q = query(collection(db, "roles"), orderBy("createdAt", "asc"));
        const querySnapshot = await getDocs(q);
        data = [];
        querySnapshot.forEach((doc) => {
          data.push({ id: doc.id, ...doc.data() });
        });
        setCachedData(data);
        showOfflineBanner(false);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:", err);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞', 'error', 5000);
        if (useCache) {
          data = getCachedData();
          fromCache = !!data;
          if (fromCache) {
            showOfflineBanner(true);
            showNotification('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à', '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞', 'warning', 4000);
          } else {
            hierarchyContainer.innerHTML = '<p style="color: #f72585; text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            return;
          }
        }
      }
    } else {
      data = getCachedData();
      fromCache = !!data;
      if (fromCache) {
        showOfflineBanner(true);
        showNotification('–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º', '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞', 'info', 4000);
      } else {
        hierarchyContainer.innerHTML = '<p style="color: #f72585; text-align: center;">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –Ω–µ—Ç –∫—ç—à–∞</p>';
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö', 'error', 5000);
        return;
      }
    }

    if (data) {
      allRoles = data;
      renderRoles();
    }
  }

  function sortRoles(roles) {
    return roles.sort((a, b) => {
      const prioA = ROLE_PRIORITY[a.role] ?? 99;
      const prioB = ROLE_PRIORITY[b.role] ?? 99;
      if (prioA !== prioB) return prioA - prioB;
      return a.nickname.localeCompare(b.nickname, 'ru');
    });
  }

  function groupRolesByRole(roles) {
    const groups = {};
    for (const role of roles) {
      if (!groups[role.role]) groups[role.role] = [];
      groups[role.role].push(role);
    }
    return groups;
  }

  function renderRoles() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const showOnlyWarnings = warningsFilter.checked;

    const filteredRoles = allRoles.filter(role => {
      const warningsIssued = role.warningsIssued || 0;
      const matchesSearch = role.nickname.toLowerCase().includes(searchTerm);
      const matchesWarnings = !showOnlyWarnings || (warningsIssued > 0);
      return matchesSearch && matchesWarnings;
    });

    const sortedRoles = sortRoles([...filteredRoles]);
    const groups = groupRolesByRole(sortedRoles);

    hierarchyContainer.innerHTML = '';

    if (Object.keys(groups).length === 0) {
      hierarchyContainer.innerHTML = '<p style="text-align:center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
      return;
    }

    const orderedGroups = Object.keys(groups).sort((a, b) => {
      return (ROLE_PRIORITY[a] ?? 99) - (ROLE_PRIORITY[b] ?? 99);
    });

    orderedGroups.forEach(roleName => {
      const section = document.createElement('div');
      section.className = 'role-section';
      section.innerHTML = `<div class="section-title">${roleName}</div>`;
      const container = document.createElement('div');
      groups[roleName].forEach(role => {
        const card = createRoleCard(role, role.id);
        container.appendChild(card);
      });
      section.appendChild(container);
      hierarchyContainer.appendChild(section);
    });
  }

  function createRoleCard(role, docId) {
    const card = document.createElement('div');
    card.className = `role-card ${role.disabled ? 'disabled' : ''} ${(role.warningsIssued || 0) > 0 ? 'warning' : ''} ${currentUser ? 'editable' : ''}`;

    const openLink = (url) => {
      if (url) window.open(url, '_blank', 'noopener,noreferrer');
    };

    const vacationText = role.onVacation ? 'üü° –í –æ—Ç–ø—É—Å–∫–µ' : 'üü¢ –†–∞–±–æ—Ç–∞–µ—Ç';
    const vacationColor = role.onVacation ? '#f1c40f' : '#2ecc71';
    
    const warningsIssued = role.warningsIssued || 0;
    const warningsMax = role.warningsMax || 3;
    const warningsBadgeClass = warningsIssued > 0 ? '' : 'no-warnings';

    const showWarningsBadge = !role.disabled;

    card.innerHTML = `
      ${showWarningsBadge ? `
      <div class="warnings-badge ${warningsBadgeClass}">
        ‚ö†Ô∏è ${warningsIssued}/${warningsMax}
      </div>
      ` : ''}
      
      <div class="role-title">${role.role}</div>
      <div class="nickname">${role.nickname}</div>
      <div class="links">
        ${role.link1 ? `<button type="button" class="link-btn" data-url="${role.link1}">–°–∞–π—Ç</button>` : ''}
        ${role.link2 ? `<button type="button" class="link-btn" data-url="${role.link2}">–°—Ç–∏–º</button>` : ''}
        ${role.link3 ? `<button type="button" class="link-btn" data-url="${role.link3}">–¢–ì</button>` : ''}
      </div>

      <div class="vacation-status" 
           style="position:absolute; bottom:10px; right:10px; background:${vacationColor};
                  color:#0f0f1b; font-weight:bold; border:none; border-radius:8px;
                  padding:6px 10px; cursor:${currentUser ? 'pointer' : 'default'}; font-size:13px;">
        ${vacationText}
      </div>

      ${currentUser ? `
        <div class="edit-overlay">
          <div class="edit-text">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        </div>
      ` : ''}
    `;

    card.querySelectorAll('.link-btn').forEach(btn => {
      btn.addEventListener('click', () => openLink(btn.dataset.url));
    });

    const vacationBtn = card.querySelector('.vacation-status');
    if (currentUser) {
      vacationBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newStatus = !role.onVacation;
        try {
          await updateDoc(doc(db, "roles", docId), { onVacation: newStatus });
          await loadAndRenderRoles();
          showNotification(
            '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 
            `${role.nickname} ${newStatus ? '–≤ –æ—Ç–ø—É—Å–∫–µ' : '—Ä–∞–±–æ—Ç–∞–µ—Ç'}`,
            'success', 
            3000
          );
        } catch (err) {
          showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—É—Å–∫–∞: ' + err.message, 'error', 5000);
        }
      });
    }

    if (currentUser) {
      card.addEventListener('click', (e) => {
        if (!e.target.closest('.link-btn') && !e.target.closest('.vacation-status') && !e.target.closest('.warnings-badge')) {
          openEditModal(docId, role);
        }
      });
    }

    return card;
  }

  function openEditModal(docId, role) {
    editingDocId = docId;
    document.getElementById('roleSelect').value = role.role;
    document.getElementById('nickname').value = role.nickname;
    document.getElementById('link1').value = role.link1 || '';
    document.getElementById('link2').value = role.link2 || '';
    document.getElementById('link3').value = role.link3 || '';
    document.getElementById('warningsIssued').value = role.warningsIssued || 0;
    document.getElementById('warningsMax').value = role.warningsMax || 3;
    document.getElementById('disabled').checked = role.disabled || false;
    
    const warningsIssuedInput = document.getElementById('warningsIssued');
    if (role.disabled) {
      warningsIssuedInput.disabled = true;
      warningsIssuedInput.style.opacity = '0.6';
      warningsIssuedInput.style.cursor = 'not-allowed';
    } else {
      warningsIssuedInput.disabled = false;
      warningsIssuedInput.style.opacity = '1';
      warningsIssuedInput.style.cursor = 'text';
    }
    
    modalTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    deleteBtn.style.display = 'block';
    modal.classList.add('active');
  }

  closeModal.onclick = () => modal.classList.remove('active');
  window.onclick = (e) => {
  if (e.target === modal) modal.classList.remove('active');
  if (e.target === loginModal) loginModal.classList.remove('active');
  if (e.target === rulesModal) rulesModal.classList.remove('active');
};

  authBtn.onclick = () => {
    if (currentUser) {
      signOut(auth);
      showNotification('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', '–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info', 4000);
    } else {
      loginModal.classList.add('active');
    }
  };

  loginForm.onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
      loginModal.classList.remove('active');
      loginForm.reset();
      showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${email}`, 'success', 4000);
    } catch (err) {
      showNotification('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', err.message, 'error', 6000);
    }
  };

  addBtn.onclick = () => {
    editingDocId = null;
    roleForm.reset();
    document.getElementById('warningsIssued').value = 0;
    document.getElementById('warningsMax').value = 3;
    const warningsIssuedInput = document.getElementById('warningsIssued');
    warningsIssuedInput.disabled = false;
    warningsIssuedInput.style.opacity = '1';
    warningsIssuedInput.style.cursor = 'text';
    modalTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å';
    deleteBtn.style.display = 'none';
    modal.classList.add('active');
  };

  roleForm.onsubmit = async (e) => {
    e.preventDefault();

    const link1 = document.getElementById('link1').value.trim();
    const link2 = document.getElementById('link2').value.trim();
    const link3 = document.getElementById('link3').value.trim();
    const isDisabled = document.getElementById('disabled').checked;

    const data = {
      role: document.getElementById('roleSelect').value,
      nickname: document.getElementById('nickname').value.trim(),
      link1,
      link2,
      link3,
      warningsIssued: isDisabled ? 0 : parseInt(document.getElementById('warningsIssued').value) || 0,
      warningsMax: parseInt(document.getElementById('warningsMax').value) || 3,
      disabled: isDisabled,
      onVacation: editingDocId ? (allRoles.find(r => r.id === editingDocId)?.onVacation ?? false) : false,
      createdAt: editingDocId ? (allRoles.find(r => r.id === editingDocId)?.createdAt ?? new Date()) : new Date()
    };

    try {
      if (editingDocId) {
        await updateDoc(doc(db, "roles", editingDocId), data);
        showNotification('–£—Å–ø–µ—à–Ω–æ', '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success', 3000);
      } else {
        await addDoc(collection(db, "roles"), data);
        showNotification('–£—Å–ø–µ—à–Ω–æ', '–ù–æ–≤–∞—è —Ä–æ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success', 3000);
      }
      modal.classList.remove('active');
      roleForm.reset();
      await loadAndRenderRoles();
    } catch (err) {
      showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', err.message, 'error', 6000);
    }
  };

  deleteBtn.onclick = async () => {
    if (!editingDocId) return;
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–æ–ª—å?')) return;

    try {
      await deleteDoc(doc(db, "roles", editingDocId));
      modal.classList.remove('active');
      showNotification('–£—Å–ø–µ—à–Ω–æ', '–†–æ–ª—å —É–¥–∞–ª–µ–Ω–∞', 'success', 3000);
      await loadAndRenderRoles();
    } catch (err) {
      showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', err.message, 'error', 6000);
    }
  };

  document.getElementById('disabled').addEventListener('change', function() {
    const warningsIssuedInput = document.getElementById('warningsIssued');
    
    if (this.checked) {
      warningsIssuedInput.value = 0;
      warningsIssuedInput.disabled = true;
      warningsIssuedInput.style.opacity = '0.6';
      warningsIssuedInput.style.cursor = 'not-allowed';
    } else {
      warningsIssuedInput.disabled = false;
      warningsIssuedInput.style.opacity = '1';
      warningsIssuedInput.style.cursor = 'text';
    }
  });

  searchInput.addEventListener('input', renderRoles);
  warningsFilter.addEventListener('change', renderRoles);

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
      addBtn.classList.add('visible');
      showNotification('–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.email}`, 'success', 4000);
    } else {
      addBtn.classList.remove('visible');
    }
    loadAndRenderRoles();
  });

  if (!isOnline()) {
    loadAndRenderRoles();
  }

  document.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    location.reload();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'F12') {
      e.preventDefault();
      location.reload();
    }

    if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i')) {
      e.preventDefault();
      location.reload();
    }

    if ((e.ctrlKey || e.metaKey) && (e.key === 'u' || e.key === 'U')) {
      e.preventDefault();
      location.reload();
    }

    if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'J' || e.key === 'j')) {
      e.preventDefault();
      location.reload();
    }
  });

  let devtools = false;
  const threshold = 160;

  setInterval(() => {
    if (window.outerHeight - window.innerHeight > threshold || 
        window.outerWidth - window.innerWidth > threshold) {
      if (!devtools) {
        devtools = true;
        window.open(location.href, '_blank');
        setTimeout(() => location.reload(), 100);
      }
    } else {
      devtools = false;
    }
  }, 1000);

const rulesBtn = document.createElement('div');
rulesBtn.className = 'rules-btn';
rulesBtn.id = 'rulesBtn';
rulesBtn.innerHTML = '<img src="https://i.yapx.ru/cFMZj.png" alt="–ü—Ä–∞–≤–∏–ª–∞" onerror="this.style.display=\'none\'; this.parentElement.innerHTML=\'üìã\'">';

authBtn.parentNode.insertBefore(rulesBtn, authBtn);

const rulesModal = document.getElementById('rulesModal');

rulesBtn.onclick = () => {
  rulesModal.classList.add('active');
};

window.onclick = (e) => {
  if (e.target === modal) modal.classList.remove('active');
  if (e.target === loginModal) loginModal.classList.remove('active');
  if (e.target === rulesModal) rulesModal.classList.remove('active');
};
</script>

</body>
</html>
